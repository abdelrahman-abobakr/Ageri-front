import apiClient from './api';
import { API_ENDPOINTS } from '../constants';

// Enrollment Service - Based on ENROLLMENT_SYSTEM_NO_EMAIL.md
class EnrollmentService {
  // Guest enrollment in course
  // Enhanced enrollInCourse method with better error handling
  static async enrollInCourse(courseId, data) {
    try {
      console.log('üîÑ Enrolling in course:', courseId);
      console.log('üîÑ Enrollment data:', data);

      const response = await apiClient.post(`/api/training/courses/${courseId}/enroll/`, data);
      console.log('‚úÖ Enrollment successful:', response.data);
      return response.data;
    } catch (error) {
      console.error('‚ùå Enrollment failed:', error);
      console.error('‚ùå Error response:', error.response);
      console.error('‚ùå Error response data:', error.response?.data);
      console.error('‚ùå Error response status:', error.response?.status);
      console.error('‚ùå Error response headers:', error.response?.headers);

      // Enhance the error object with the response data
      if (error.response) {
        error.responseData = error.response.data;

        // Log detailed error information
        if (error.response.data) {
          console.error('‚ùå Detailed error data:');
          Object.entries(error.response.data).forEach(([key, value]) => {
            console.error(`   ${key}:`, value);
          });
        }
      }

      throw error;
    }
  }

  // Look up enrollment by token
  static async lookupEnrollment(enrollmentToken) {
    try {
      console.log('üîç Looking up enrollment:', enrollmentToken);
      const response = await apiClient.get(
        `api/training/enrollments/lookup/${enrollmentToken}/`
      );
      console.log('‚úÖ Enrollment found:', response.data);
      return response.data;
    } catch (error) {
      console.error('‚ùå Enrollment lookup failed:', error);
      if (error.response?.status === 404) {
        throw new Error('Enrollment not found. Please check your enrollment ID.');
      }
      throw new Error('Failed to lookup enrollment');
    }
  }

  // Get user's enrollments (for authenticated users)
  static async getMyEnrollments() {
    try {
      console.log('üìÑ Fetching user enrollments');
      const response = await apiClient.get(API_ENDPOINTS.TRAINING.MY_ENROLLMENTS);
      console.log('‚úÖ User enrollments loaded:', response.data);
      return response.data;
    } catch (error) {
      console.error('‚ùå Failed to load user enrollments:', error);
      throw error;
    }
  }

  // Admin: Get all enrollments with filters
  static async getEnrollments(filters = {}) {
    try {
      console.log('üìÑ Fetching enrollments with filters:', filters);
      const response = await apiClient.get(API_ENDPOINTS.TRAINING.ENROLLMENTS, {
        params: filters
      });
      console.log('‚úÖ Enrollments loaded from backend:', response.data);
      return response.data;
    } catch (error) {
      console.error('‚ùå Failed to load enrollments:', error);
      throw error;
    }
  }

  // Admin: Get enrollment details
  static async getEnrollmentDetails(enrollmentId) {
    try {
      console.log('üìÑ ===== FETCHING ENROLLMENT DETAILS =====');
      console.log('üìÑ Enrollment ID:', enrollmentId);
      const response = await apiClient.get(
        API_ENDPOINTS.TRAINING.ENROLLMENT_DETAIL(enrollmentId)
      );
      console.log('‚úÖ ===== ENROLLMENT DETAILS SUCCESS =====');
      console.log('‚úÖ Response data:', response.data);
      return response.data;
    } catch (error) {
      console.error('‚ùå ===== ENROLLMENT DETAILS ERROR =====');
      console.error('‚ùå Failed to load enrollment details:', error);
      if (error.response?.status === 404) {
        throw new Error('Enrollment not found');
      }
      throw error;
    }
  }

  // Admin: Update enrollment
  static async updateEnrollment(enrollmentId, updateData) {
    try {
      console.log('üìÑ ===== ENROLLMENT UPDATE REQUEST =====');
      console.log('üìÑ Enrollment ID:', enrollmentId);
      console.log('üìÑ Update data:', updateData);
      const response = await apiClient.patch(
        API_ENDPOINTS.TRAINING.ENROLLMENT_DETAIL(enrollmentId),
        updateData
      );
      console.log('‚úÖ ===== ENROLLMENT UPDATE SUCCESS =====');
      console.log('‚úÖ Response:', response.data);
      return response.data;
    } catch (error) {
      console.error('‚ùå ===== ENROLLMENT UPDATE ERROR =====');
      console.error('‚ùå Error details:', error);
      const errorData = error.response?.data;
      throw new Error(errorData?.message || error.message || 'Failed to update enrollment');
    }
  }

  // Admin: Update payment information
  static async updatePayment(enrollmentId, paymentData) {
    try {
      console.log('üìÑ ===== PAYMENT UPDATE REQUEST =====');
      console.log('üìÑ Enrollment ID:', enrollmentId);
      console.log('üìÑ Payment data:', paymentData);

      // Try the payment-specific endpoint first
      try {
        const response = await apiClient.patch(
          `api/training/enrollments/${enrollmentId}/payment/`,
          paymentData
        );
        console.log('‚úÖ ===== PAYMENT UPDATE SUCCESS (PAYMENT ENDPOINT) =====');
        return response.data;
      } catch (paymentEndpointError) {
        console.log('üìÑ Payment endpoint not available, falling back to general update');
        // Fallback to general update endpoint
        return await this.updateEnrollment(enrollmentId, paymentData);
      }
    } catch (error) {
      console.error('‚ùå ===== PAYMENT UPDATE ERROR =====');
      console.error('‚ùå Error details:', error);
      const errorData = error.response?.data;
      throw new Error(errorData?.message || error.message || 'Failed to update payment information');
    }
  }

  // Admin: Mark enrollment as completed
  static async markCompleted(enrollmentId) {
    try {
      console.log('üìÑ Marking enrollment as completed:', enrollmentId);

      // Try the specific mark completed endpoint first
      try {
        const response = await apiClient.post(
          API_ENDPOINTS.TRAINING.MARK_COMPLETED(enrollmentId)
        );
        console.log('‚úÖ Enrollment marked as completed:', response.data);
        return response.data;
      } catch (specificEndpointError) {
        console.log('üìÑ Mark completed endpoint not available, using general update');
        // Fallback to general update
        return await this.updateEnrollment(enrollmentId, { status: 'completed' });
      }
    } catch (error) {
      console.error('‚ùå Failed to mark enrollment as completed:', error);
      const errorData = error.response?.data;
      throw new Error(errorData?.message || error.message || 'Failed to mark enrollment as completed');
    }
  }

  // Admin: Delete enrollment - NEW METHOD
  static async deleteEnrollment(enrollmentId) {
    try {
      console.log('üìÑ Deleting enrollment with ID:', enrollmentId);
      console.log('üìÑ Enrollment ID type:', typeof enrollmentId);

      if (!enrollmentId) {
        throw new Error('Enrollment ID is required for deletion');
      }

      const deleteUrl = API_ENDPOINTS.TRAINING.ENROLLMENT_DETAIL(enrollmentId);
      console.log('üìÑ Delete URL:', deleteUrl);

      const response = await apiClient.delete(deleteUrl);
      console.log('‚úÖ Enrollment deleted successfully, response:', response);

      return {
        success: true,
        message: 'Enrollment deleted successfully',
        data: response.data
      };
    } catch (error) {
      console.error('‚ùå Failed to delete enrollment:', error);

      // Enhanced error handling
      if (error.response) {
        const { status, data } = error.response;
        switch (status) {
          case 404:
            throw new Error('Enrollment not found or already deleted');
          case 403:
            throw new Error('You do not have permission to delete this enrollment');
          case 400:
            throw new Error(data?.message || 'Cannot delete enrollment');
          case 409:
            throw new Error('Cannot delete enrollment due to conflicts');
          default:
            throw new Error(data?.message || `Server error: ${status}`);
        }
      } else if (error.request) {
        throw new Error('Network error - please check your connection');
      } else {
        throw new Error(error.message || 'An unexpected error occurred');
      }
    }
  }

  // Admin: Bulk update status - NEW METHOD
  static async bulkUpdateStatus(enrollmentIds, status) {
    try {
      console.log('üìÑ Bulk updating status for enrollments:', enrollmentIds, 'to status:', status);

      const response = await apiClient.patch('api/training/enrollments/bulk-update/', {
        enrollment_ids: enrollmentIds,
        status: status
      });

      console.log('‚úÖ Bulk status update result:', response.data);
      return response.data;
    } catch (error) {
      console.error('‚ùå Failed to bulk update status:', error);

      // Fallback: update each enrollment individually
      console.log('üìÑ Attempting individual updates as fallback');
      let successful = 0;
      let failed = 0;

      for (const enrollmentId of enrollmentIds) {
        try {
          await this.updateEnrollment(enrollmentId, { status });
          successful++;
        } catch (individualError) {
          console.error(`‚ùå Failed to update enrollment ${enrollmentId}:`, individualError);
          failed++;
        }
      }

      return { successful, failed };
    }
  }

  // Admin: Bulk delete enrollments - NEW METHOD
  static async bulkDelete(enrollmentIds) {
    try {
      console.log('üìÑ Bulk deleting enrollments:', enrollmentIds);

      const response = await apiClient.delete('api/training/enrollments/bulk-delete/', {
        data: { enrollment_ids: enrollmentIds }
      });

      console.log('‚úÖ Bulk delete result:', response.data);
      return response.data;
    } catch (error) {
      console.error('‚ùå Failed to bulk delete:', error);

      // Fallback: delete each enrollment individually
      console.log('üìÑ Attempting individual deletions as fallback');
      let successful = 0;
      let failed = 0;

      for (const enrollmentId of enrollmentIds) {
        try {
          await this.deleteEnrollment(enrollmentId);
          successful++;
        } catch (individualError) {
          console.error(`‚ùå Failed to delete enrollment ${enrollmentId}:`, individualError);
          failed++;
        }
      }

      return { successful, failed };
    }
  }

  // Admin: Test connection - NEW METHOD
  static async testConnection() {
    try {
      console.log('üìÑ Testing connection to enrollment service');

      // Try to fetch a small amount of data to test connection
      const response = await apiClient.get('api/training/enrollments/', {
        params: { page: 1, page_size: 1 }
      });

      console.log('‚úÖ Connection test successful:', response.data);
      return {
        success: true,
        message: 'Connection successful'
      };
    } catch (error) {
      console.error('‚ùå Connection test failed:', error);
      return {
        success: false,
        message: error.message || 'Connection failed'
      };
    }
  }

  // Admin: Issue certificate for enrollment
  static async issueCertificate(enrollmentId) {
    try {
      console.log('üìÑ Issuing certificate for enrollment:', enrollmentId);
      const response = await apiClient.post(
        API_ENDPOINTS.TRAINING.ISSUE_CERTIFICATE(enrollmentId)
      );
      console.log('‚úÖ Certificate issued:', response.data);
      return response.data;
    } catch (error) {
      console.error('‚ùå Failed to issue certificate:', error);
      throw error;
    }
  }

  // Admin: Get enrollment statistics
  static async getEnrollmentStats(filters = {}) {
    try {
      console.log('üìÑ Fetching enrollment statistics');
      const response = await apiClient.get(API_ENDPOINTS.TRAINING.ENROLLMENT_STATS, {
        params: filters
      });
      console.log('‚úÖ Enrollment stats loaded:', response.data);
      return response.data;
    } catch (error) {
      console.error('‚ùå Failed to load enrollment stats:', error);
      throw error;
    }
  }

  // Validate enrollment data
  static validateEnrollmentData(data) {
    const errors = {};

    // Validate required fields
    if (!data.first_name || data.first_name.trim().length === 0) {
      errors.first_name = 'ÿßŸÑÿßÿ≥ŸÖ ÿßŸÑÿ£ŸàŸÑ ŸÖÿ∑ŸÑŸàÿ®';
    }

    if (!data.last_name || data.last_name.trim().length === 0) {
      errors.last_name = 'ÿßŸÑÿßÿ≥ŸÖ ÿßŸÑÿ£ÿÆŸäÿ± ŸÖÿ∑ŸÑŸàÿ®';
    }

    if (!data.email || data.email.trim().length === 0) {
      errors.email = 'ÿßŸÑÿ®ÿ±ŸäÿØ ÿßŸÑÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä ŸÖÿ∑ŸÑŸàÿ®';
    } else {
      // Validate email format
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!emailRegex.test(data.email)) {
        errors.email = 'Ÿäÿ±ÿ¨Ÿâ ÿ•ÿØÿÆÿßŸÑ ÿ®ÿ±ŸäÿØ ÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä ÿµÿ≠Ÿäÿ≠';
      }
    }

    if (!data.experience_level || data.experience_level.trim().length === 0) {
      errors.experience_level = 'ŸÖÿ≥ÿ™ŸàŸâ ÿßŸÑÿÆÿ®ÿ±ÿ© ŸÖÿ∑ŸÑŸàÿ®';
    }

    // Validate phone format if provided
    if (data.phone && data.phone.trim().length > 0) {
      const phoneRegex = /^[\+]?[0-9\s\-()]{7,}$/;
      if (!phoneRegex.test(data.phone)) {
        errors.phone = 'Ÿäÿ±ÿ¨Ÿâ ÿ•ÿØÿÆÿßŸÑ ÿ±ŸÇŸÖ Ÿáÿßÿ™ŸÅ ÿµÿ≠Ÿäÿ≠';
      }
    }

    // Validate education level if provided
    const validEducationLevels = ['high_school', 'bachelor', 'master', 'phd', 'other'];
    if (data.education_level && !validEducationLevels.includes(data.education_level)) {
      errors.education_level = 'ÿßŸÑŸÖÿ≥ÿ™ŸàŸâ ÿßŸÑÿ™ÿπŸÑŸäŸÖŸä ÿ∫Ÿäÿ± ÿµÿ≠Ÿäÿ≠';
    }

    // Validate experience level if provided
    const validExperienceLevels = ['beginner', 'intermediate', 'advanced'];
    if (data.experience_level && !validExperienceLevels.includes(data.experience_level)) {
      errors.experience_level = 'ŸÖÿ≥ÿ™ŸàŸâ ÿßŸÑÿÆÿ®ÿ±ÿ© ÿ∫Ÿäÿ± ÿµÿ≠Ÿäÿ≠';
    }

    return {
      isValid: Object.keys(errors).length === 0,
      errors
    };
  }

  // Helper method to calculate stats from enrollments data
  static calculateStatsFromEnrollments(enrollments) {
    const total = enrollments.length;
    const active = enrollments.filter(e => e.status === 'active').length;
    const completed = enrollments.filter(e => e.status === 'completed').length;
    const pending = enrollments.filter(e => e.status === 'pending').length;
    return {
      total_enrollments: total,
      active_enrollments: active,
      completed_enrollments: completed,
      pending_enrollments: pending,
      completion_rate: total > 0 ? ((completed / total) * 100).toFixed(1) : 0
    };
  }

  // Admin: Export enrollments to PDF - ENHANCED METHOD
  static async exportEnrollmentsPDF(exportOptions = {}) {
    try {
      console.log('üìÑ ===== EXPORTING ENROLLMENTS TO PDF =====');
      console.log('üìÑ Export options:', exportOptions);
      return await this.generateEnrollmentsPDF(exportOptions);
    } catch (error) {
      console.error('‚ùå PDF export failed:', error);
      throw error;
    }
  }

  // Generate PDF using HTML approach (better Unicode support)
  static async generateEnrollmentsPDF(exportOptions = {}) {
    try {
      console.log('üìÑ Using HTML-to-PDF approach for better Unicode support');

      const filters = {};
      const courseId = exportOptions.course || exportOptions.course_id;
      if (courseId && courseId !== '') {
        filters.course = courseId;
      }

      console.log('üìÑ Fetching enrollments with filters:', filters);
      const enrollmentData = await this.getEnrollments(filters);
      const enrollmentsList = enrollmentData.results || [];

      if (enrollmentsList.length === 0) {
        throw new Error('ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ®ŸäÿßŸÜÿßÿ™ ÿ™ÿ≥ÿ¨ŸäŸÑ ŸÑŸÑÿ™ÿµÿØŸäÿ±');
      }

      console.log('üìÑ Processing enrollments for PDF...');
      const enrollments = [];
      for (let i = 0; i < Math.min(enrollmentsList.length, 50); i++) {
        const enrollment = enrollmentsList[i];
        try {
          const detailedData = await this.getEnrollmentDetails(enrollment.id);
          enrollments.push(detailedData);
        } catch (detailError) {
          console.log('üìÑ Could not get detailed data for enrollment, using basic data');
          enrollments.push(enrollment);
        }
      }

      if (enrollments.length === 0) {
        throw new Error('ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ®ŸäÿßŸÜÿßÿ™ ÿ™ÿ≥ÿ¨ŸäŸÑ ŸÑŸÑÿ™ÿµÿØŸäÿ±');
      }

      const courseTitle = (exportOptions.course || exportOptions.course_id)
        ? enrollments[0]?.course_title || 'Selected Course'
        : 'All Courses';

      let htmlContent = `
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Enrollments Report - ${courseTitle}</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; direction: rtl; }
    h1 { color: #2980b9; margin-bottom: 10px; text-align: center; }
    .info { margin-bottom: 20px; color: #666; text-align: center; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th { background-color: #2980b9; color: white; padding: 10px; text-align: center; border: 1px solid #ddd; }
    td { padding: 8px; border: 1px solid #ddd; text-align: center; }
    tr:nth-child(even) { background-color: #f9f9f9; }
    tr:hover { background-color: #f5f5f5; }
    .center { text-align: center; }
    @media print {
      body { margin: 10px; }
      .info { page-break-after: avoid; }
      table { page-break-inside: avoid; }
    }
  </style>
</head>
<body>
  <h1>ÿ™ŸÇÿ±Ÿäÿ± ÿßŸÑÿ™ÿ≥ÿ¨ŸäŸÑÿßÿ™ - ${courseTitle}</h1>
  <div class="info">
    <p><strong>ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ™ÿµÿØŸäÿ±:</strong> ${new Date().toLocaleDateString('ar-EG')}</p>
    <p><strong>ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑÿ™ÿ≥ÿ¨ŸäŸÑÿßÿ™:</strong> ${enrollments.length}</p>
  </div>
  <table>
    <thead>
      <tr>
        <th class="center">#</th>
        <th>ÿßŸÑÿßÿ≥ŸÖ</th>
        <th>ÿßŸÑÿ®ÿ±ŸäÿØ ÿßŸÑÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä</th>`;

      // Add conditional columns based on export options
      if (exportOptions.include_contact) {
        htmlContent += `<th>ÿßŸÑŸáÿßÿ™ŸÅ</th>`;
      }

      htmlContent += `<th>ÿßŸÑÿØŸàÿ±ÿ©</th>
        <th>ÿ≠ÿßŸÑÿ© ÿßŸÑÿ™ÿ≥ÿ¨ŸäŸÑ</th>`;

      if (exportOptions.include_payment) {
        htmlContent += `<th>ÿ≠ÿßŸÑÿ© ÿßŸÑÿØŸÅÿπ</th><th>ÿßŸÑŸÖÿ®ŸÑÿ∫</th>`;
      }

      if (exportOptions.include_dates) {
        htmlContent += `<th>ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ™ÿ≥ÿ¨ŸäŸÑ</th>`;
      }

      htmlContent += `
      </tr>
    </thead>
    <tbody>
`;

      enrollments.forEach((enrollment, index) => {
        const fullName = enrollment.user
          ? `${enrollment.user.first_name} ${enrollment.user.last_name}`
          : `${enrollment.first_name || ''} ${enrollment.last_name || ''}`.trim() || enrollment.enrollee_name || 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ';
        const email = enrollment.user?.email || enrollment.enrollee_email || enrollment.email || 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ';
        const phone = enrollment.phone || 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ';
        const courseName = enrollment.course_title || enrollment.course?.course_name || 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ';
        const status = enrollment.status === 'completed' ? 'ŸÖŸÉÿ™ŸÖŸÑ' :
          enrollment.status === 'approved' ? 'ŸÖŸÇÿ®ŸàŸÑ' :
            enrollment.status === 'pending' ? 'ŸÅŸä ÿßŸÑÿßŸÜÿ™ÿ∏ÿßÿ±' : 'ŸÖÿ±ŸÅŸàÿ∂';
        const paymentStatus = enrollment.payment_status === 'paid' ? 'ŸÖÿØŸÅŸàÿπ' :
          enrollment.payment_status === 'failed' ? 'ŸÅÿ¥ŸÑ' :
            enrollment.payment_status === 'refunded' ? 'ŸÖÿ≥ÿ™ÿ±ÿØ' : 'ŸÅŸä ÿßŸÑÿßŸÜÿ™ÿ∏ÿßÿ±';
        const paymentAmount = enrollment.payment_amount || '0.00';
        const enrollDate = new Date(enrollment.enrollment_date).toLocaleDateString('ar-EG');

        htmlContent += `
      <tr>
        <td class="center">${index + 1}</td>
        <td>${fullName}</td>
        <td>${email}</td>`;

        if (exportOptions.include_contact) {
          htmlContent += `<td>${phone}</td>`;
        }

        htmlContent += `<td>${courseName}</td>
        <td>${status}</td>`;

        if (exportOptions.include_payment) {
          htmlContent += `<td>${paymentStatus}</td><td>${paymentAmount} ÿ¨ŸÜŸäŸá</td>`;
        }

        if (exportOptions.include_dates) {
          htmlContent += `<td>${enrollDate}</td>`;
        }

        htmlContent += `</tr>`;
      });

      htmlContent += `
    </tbody>
  </table>
  <div style="margin-top: 30px; text-align: center; color: #666; font-size: 12px;">
    <p>ÿ™ŸÖ ÿ•ŸÜÿ¥ÿßÿ° Ÿáÿ∞ÿß ÿßŸÑÿ™ŸÇÿ±Ÿäÿ± ÿ®Ÿàÿßÿ≥ÿ∑ÿ© ŸÜÿ∏ÿßŸÖ ÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿ™ÿØÿ±Ÿäÿ®</p>
  </div>
</body>
</html>
`;

      console.log('üìÑ Opening print dialog for PDF generation');
      const printWindow = window.open('', '_blank');
      printWindow.document.write(htmlContent);
      printWindow.document.close();

      // Wait for content to load then show print dialog
      setTimeout(() => {
        printWindow.focus();
        printWindow.print();
      }, 500);

      console.log('‚úÖ PDF generation initiated successfully');
      return true;
    } catch (error) {
      console.error('‚ùå PDF generation failed:', error);
      throw error;
    }
  }
}

export default EnrollmentService;